<div class="max-w-6xl mx-auto p-6 h-full flex flex-col">
  <!-- no journal and no images -->
  <ng-content *ngIf="!marker().journal && images().length === 0">
    <ng-content *ngTemplateOutlet="noJournalOrImages"></ng-content>
  </ng-content>

  <ng-template #noJournalOrImages>
    <div class="flex items-end justify-between">
      <ng-content *ngTemplateOutlet="breadcrumbs"></ng-content>
      <div class="flex">
        <app-button
          [config]="addJournalEntryButtonConfig"
          (btnClick)="isJournalEntryDialogOpen.set(!isJournalEntryDialogOpen())"
        ></app-button>
        <app-image-upload
          [mapId]="mapId"
          [markerId]="markerId"
        ></app-image-upload>
      </div>
    </div>
    <ng-content
      *ngTemplateOutlet="
        missingThingsEmoji;
        context: { text: 'You don\'t any images yet or journal entry yet.' }
      "
    ></ng-content>
  </ng-template>

  <!-- images but no journal -->
  <ng-content *ngIf="!marker().journal && images().length > 0">
    <div class="flex items-end justify-between">
      <ng-content *ngTemplateOutlet="breadcrumbs"></ng-content>
      <div class="flex">
        <app-button
          [config]="addJournalEntryButtonConfig"
          (btnClick)="isJournalEntryDialogOpen.set(!isJournalEntryDialogOpen())"
        ></app-button>
        <app-image-upload
          [mapId]="mapId"
          [markerId]="markerId"
        ></app-image-upload>
      </div>
    </div>
    <ng-content *ngTemplateOutlet="onlyImages"> </ng-content>
  </ng-content>

  <ng-template #onlyImages>
    <ng-content *ngTemplateOutlet="imageGrid"></ng-content>
  </ng-template>

  <!-- journal but no images -->
  <ng-content *ngIf="marker().journal && images().length === 0">
    <ng-content *ngTemplateOutlet="onlyJournal"></ng-content>
  </ng-content>

  <ng-template #onlyJournal>
    <ng-content *ngTemplateOutlet="breadcrumbs"></ng-content>
    <ng-content *ngTemplateOutlet="journal"></ng-content>
    <ng-content
      *ngTemplateOutlet="
        missingThingsEmoji;
        context: { text: 'You don\'t any images yet.' }
      "
    ></ng-content>
  </ng-template>

  <!-- journals and images -->
  <ng-content *ngIf="marker().journal && images().length > 0">
    <ng-content *ngTemplateOutlet="journalAndImages"></ng-content>
  </ng-content>

  <ng-template #journalAndImages>
    <ng-content *ngTemplateOutlet="breadcrumbs"></ng-content>
    <ng-content *ngTemplateOutlet="journal"></ng-content>
    <ng-content *ngTemplateOutlet="imageGrid"></ng-content>
  </ng-template>
</div>

<!-- templates -->

<ng-template #breadcrumbs>
  <div id="breadcrumbs" class="mt-6 mb-6">
    <a
      class="text-sm font-medium text-blue-600 underline hover:text-blue-900 cursor-pointer"
      [routerLink]="['/maps']"
      >Yours maps >
    </a>
    <a
      class="text-sm font-medium text-blue-600 underline hover:text-blue-900 cursor-pointer"
      [routerLink]="['/markers', mapId]"
      >{{ mapTitle }} >
    </a>
    <h1 class="text-6xl font-bold">
      {{ marker().title }}
    </h1>
  </div>
</ng-template>

<ng-template #journal>
  <div id="journal" class="mt-6 mb-6">
    <p class="break-words">
      @if (marker().journal) {
      {{ marker().journal }}
      }
    </p>
    <button
      *ngIf="marker().journal"
      (click)="isJournalEntryDialogOpen.set(!isJournalEntryDialogOpen())"
      class="text-sm text-blue-600 underline hover:text-blue-800 cursor-pointer"
    >
      Manage journal entry
    </button>
  </div>
  <app-image-upload [mapId]="mapId" [markerId]="markerId"></app-image-upload>
</ng-template>

<!-- Image Grid Section -->
<ng-template #imageGrid>
  <div class="mt-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
    @for (image of images(); track $index) {

    <div class="relative">
      <app-dropdown
        [config]="dropdownConfig"
        class="absolute right-1 top-1"
        (optionSelected)="onDropdownOptionSelected($event, $index)"
      >
      </app-dropdown>

      @if (image.legend) {
      <app-button
        [config]="displayCaptionButtonConfig"
        (btnClick)="handleClick($index)"
        class="absolute left-1 top-1"
      ></app-button>
      }

      <img
        [src]="image.url"
        (click)="isLightboxOpen.set(true)"
        [alt]="image.legend"
        class="w-full h-auto shadow-lg hover:shadow-xl transition-shadow duration-300 cursor-pointer"
      />
    </div>
    }
  </div>
</ng-template>

<ng-template #missingThingsEmoji let-text="text">
  <div class="flex-2 flex flex-col justify-center text-center">
    <p class="text-6xl m-6">¯\_(ツ)_/¯</p>
    <p class="text-zinc-800 text-xl m-6">
      {{ text }}
    </p>
  </div>
</ng-template>

<app-dialog
  #deleteImageDialog
  [dialogConfig]="deleteDialogConfig"
  [open]="isDeleteDialogOpen()"
  (dialogClosed)="onDeleteDialogClosed($event)"
>
  <app-warning-banner
    [warningText]="'Are you sure? This action is irreversible.'"
  ></app-warning-banner>
</app-dialog>

<app-dialog
  #addCaptionDialog
  [dialogConfig]="addCaptionDialogConfig"
  [open]="isAddCaptionDialogOpen()"
  (dialogClosed)="saveCaption()"
>
  <input
    [formControl]="addCaptionFormControl"
    type="text"
    placeholder="Say something about this image..."
    class="w-100 p-4 border border-zinc-300"
  />
</app-dialog>

<app-dialog
  #displayCaptionDialog
  [dialogConfig]="displayCaptionDialogConfig"
  [open]="isDisplayCaptionDialogOpen()"
>
  <i>{{
    focusedImagedIndex() !== null && images()[focusedImagedIndex()!].legend
  }}</i>
</app-dialog>

<app-dialog
  #addJournalEntryDialog
  [dialogConfig]="addJournalEntryDialogConfig"
  [open]="isJournalEntryDialogOpen()"
  (dialogClosed)="addJournalEntry($event)"
>
  <textarea
    [formControl]="addJournalEntryFormControl"
    [value]="addJournalEntryFormControl.value"
    placeholder="Say something about this marker..."
    class="w-full p-2 border rounded-md"
    rows="4"
    >{{ addJournalEntryFormControl.value }}</textarea
  >
</app-dialog>

<!-- open is controlled from outside because of the event handlers on the lightbox -->
@if (isLightboxOpen()) {
<app-lightbox
  [images]="images()"
  [lightboxConfig]="lightboxConfig"
  (close)="isLightboxOpen.set(false)"
></app-lightbox>
}
